<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Kakveda - LLM Failure Intelligence Platform</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    header { position: sticky; top: 0; z-index: 10; padding: 16px 24px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .brand strong { font-size: 1.3em; color: #60a5fa; }
    .small { color: var(--muted); font-size: 0.88em; }
    .nav { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .wrap { padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1600px; margin: 0 auto; }
    .full { grid-column: 1 / -1; }
    .row { display: flex; gap: 10px; align-items: center; }
    .pill { display: inline-block; padding: 4px 12px; border-radius: 999px; background: rgba(37,99,235,0.12); border: 1px solid rgba(37,99,235,0.35); font-size: 0.88em; font-weight: 500; }
    .pill-link { cursor: pointer; text-decoration: none; color: inherit; }
    .pill-link:hover .pill { background: rgba(37,99,235,0.25); }
    .pill.severity-high { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: #fca5a5; }
    .pill.severity-medium { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); color: #fcd34d; }
    .pill.severity-low { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: #86efac; }
    .btn.secondary { background: rgba(255,255,255,0.06); border: 1px solid var(--border2); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .card h3 { margin: 0 0 16px 0; font-size: 1.1em; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    thead th { background: rgba(0,0,0,0.3); padding: 12px 14px; font-weight: 600; font-size: 0.8em; text-transform: uppercase; color: var(--muted); }
    thead th:first-child { border-radius: 8px 0 0 8px; }
    thead th:last-child { border-radius: 0 8px 8px 0; }
    tbody tr:hover { background: rgba(37,99,235,0.06); }
    tbody td { padding: 12px 14px; border-bottom: 1px solid rgba(36,48,74,0.5); }
    .clickable-row { cursor: pointer; }
    .stats-bar { display: flex; gap: 16px; padding: 16px 20px; margin-bottom: 20px; background: rgba(37,99,235,0.08); border: 1px solid rgba(37,99,235,0.2); border-radius: 12px; }
    .stat-item { text-align: center; flex: 1; padding: 8px; }
    .stat-value { font-size: 1.8em; font-weight: 700; color: #60a5fa; }
    .stat-label { font-size: 0.75em; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    .nav-links { display: flex; gap: 6px; flex-wrap: wrap; }
    .nav-links a { padding: 6px 12px; border-radius: 6px; font-size: 0.9em; }
    .nav-links a:hover { background: rgba(37,99,235,0.15); text-decoration: none; }
    .nav-links a.active { background: rgba(37,99,235,0.2); color: #60a5fa; }
    @media (max-width: 1000px) { .wrap { grid-template-columns: 1fr; padding: 16px; } header { flex-direction: column; gap: 12px; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/static/logo.svg" alt="Kakveda" style="height: 36px;" />
      <span class="small">|</span>
      <span class="small">{{ role }} - {{ email }}</span>
      {% if role == 'admin' %}<span class="pill" style="background: rgba(251,113,133,0.14); border:1px solid rgba(251,113,133,0.30); font-size:0.75em;">ADMIN</span>{% endif %}
    </div>
    <div class="nav">
      <div class="nav-links">
        <a href="/" class="active">Dashboard</a>
        <a href="/runs">Runs</a>
        <a href="/scenarios">Scenarios</a>
        <a href="/playground">Playground</a>
        <a href="/warnings">Warnings</a>
        <a href="/datasets">Datasets</a>
        <a href="/prompts">Prompts</a>
        <a href="/experiments">Experiments</a>
        <a href="/projects">Projects</a>
        {% if role == 'admin' %}<a href="/admin/users">Admin</a>{% endif %}
      </div>
      <form method="post" action="/auth/logout" style="display:inline-block; margin-left:8px;">
        {{ csrf_input(request) | safe }}
        <button class="btn" type="submit" style="padding:8px 16px;">Logout</button>
      </form>
    </div>
  </header>

  <div style="padding:20px 24px 0; max-width:1600px; margin:0 auto;">
    <div class="stats-bar">
      <div class="stat-item"><div class="stat-value">{{ failures|length }}</div><div class="stat-label">Failures</div></div>
      <div class="stat-item"><div class="stat-value">{{ patterns|length }}</div><div class="stat-label">Patterns</div></div>
      <div class="stat-item"><div class="stat-value">{{ warnings|length }}</div><div class="stat-label">Warnings</div></div>
      <div class="stat-item"><div class="stat-value">--</div><div class="stat-label">Health</div></div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3>Failures (latest)</h3>
      <table>
        <thead><tr><th>ID</th><th>Type</th><th>Severity</th><th>Apps</th><th>Count</th></tr></thead>
        <tbody>
          {% for f in failures %}
          <tr class="clickable-row" onclick="window.location='/failure/{{ f.failure_id }}'">
            <td><a href="/failure/{{ f.failure_id }}" class="pill-link"><span class="pill">{{ f.failure_id }}v{{ f.version }}</span></a></td>
            <td>{{ f.failure_type }}</td>
            <td><span class="pill severity-{{ f.impact_severity|lower }}">{{ f.impact_severity }}</span></td>
            <td>{{ (f.affected_apps or []) | join(", ") }}</td>
            <td><strong>{{ f.occurrences }}</strong></td>
          </tr>
          {% else %}
          <tr><td colspan="5" style="text-align:center; color:var(--muted); padding:30px;">No failures recorded</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small" style="margin-top:12px;">Click any failure for details</p>
    </div>

    <div class="card">
      <h3>Patterns</h3>
      <table>
        <thead><tr><th>ID</th><th>Name</th><th>Affected Apps</th></tr></thead>
        <tbody>
          {% for p in patterns %}
          <tr>
            <td><span class="pill">{{ p.pattern_id }}</span></td>
            <td>{{ p.name }}</td>
            <td>{{ (p.affected_apps or []) | join(", ") }}</td>
          </tr>
          {% else %}
          <tr><td colspan="3" style="text-align:center; color:var(--muted); padding:30px;">No patterns detected</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card full">
      <h3>Health Score Trend</h3>
      <canvas id="healthChart" height="80"></canvas>
    </div>

    <div class="card full">
      <div class="row" style="justify-content:space-between; margin-bottom:12px;">
        <h3 style="margin:0">Recent Warnings</h3>
        <a href="/warnings" class="btn secondary" style="padding:6px 14px; font-size:0.85em;">View All</a>
      </div>
      <table>
        <thead><tr><th>When</th><th>App</th><th>Action</th><th>Confidence</th><th>Pattern</th><th>Message</th></tr></thead>
        <tbody>
          {% for w in warnings %}
          <tr>
            <td class="small">{{ w.ts }}</td>
            <td><span class="pill">{{ w.app_id }}</span></td>
            <td>{{ w.action }}</td>
            <td>{{ (w.confidence * 100)|int }}%</td>
            <td>{{ w.pattern_id or '-' }}</td>
            <td class="small">{{ w.message }}</td>
          </tr>
          {% else %}
          <tr><td colspan="6" style="text-align:center; color:var(--muted); padding:30px;">No warnings</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    var points = {{ health_points | tojson }};
    var ctx = document.getElementById('healthChart');
    if (window.Chart && points.length) {
      new Chart(ctx, {
        type: 'line',
        data: { labels: points.map(function(p){return p.ts;}), datasets: [{ label: 'Health', data: points.map(function(p){return p.score;}), borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.15)', tension: 0.3, fill: true }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#9aa8bf' } }, y: { min: 0, max: 100, ticks: { color: '#9aa8bf' } } } }
      });
    }
  </script>
  
  <footer style="text-align: center; padding: 24px; margin-top: 40px; border-top: 1px solid var(--border); color: var(--muted); font-size: 0.85em;">
    © 2026 Prateek Chaudhary · Open source under <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" style="color: var(--link);">Apache License 2.0</a>
  </footer>
</body>
</html>
