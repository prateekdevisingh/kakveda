<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>kakveda</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    header{position:sticky; top:0; z-index:10; padding:14px 18px; background: var(--bg); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;}
    .brand{display:flex; gap:10px; align-items:baseline}
    .small{color:var(--muted); font-size:.9em}
    .nav{display:flex; gap:10px; align-items:center}
    .wrap{padding:18px; display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    .full { grid-column: 1 / -1; }
    .row{display:flex; gap:10px; align-items:center}
    .pill{display:inline-block; padding:2px 10px; border-radius:999px; background: rgba(37,99,235,.12); border:1px solid rgba(37,99,235,.35);}
    .btn.secondary{background: rgba(255,255,255,.06); border: 1px solid var(--border2);}
  </style>
</head>
<body>
  <header>
    <div class="brand">
  <strong>kakveda</strong>
  <span class="small" style="margin-left:8px; opacity:.9">Author: Prateek Chaudhary</span>
      <span class="small">role: {{ role }} · {{ email }}</span>
      {% if role == 'admin' %}
      <span class="pill" style="margin-left:8px; background: rgba(251,113,133,.14); border:1px solid rgba(251,113,133,.30);">ADMIN</span>
      {% endif %}
      {% if request.cookies.get('aitester_impersonate_role') %}
      <form method="post" action="/admin/impersonate/clear" style="display:inline-block; margin-left:10px;">
          {{ csrf_input(request) | safe }}
        <button class="btn secondary" type="submit" style="padding:6px 10px; border-radius:999px;">
          Currently viewing as: {{ role }} (clear)
        </button>
      </form>
      {% endif %}
    <div>
      <a href="/">Dashboard</a> · <a href="/runs">Runs</a> · <a href="/scenarios">Scenarios</a> · <a href="/playground">Playground</a> · <a href="/warnings">Warnings</a> · <a href="/datasets">Datasets</a> · <a href="/prompts">Prompts</a> · <a href="/experiments">Experiments</a> · <a href="/projects">Projects</a>
      {% if role == 'admin' %} · <a href="/admin/users">Admin Panel</a>{% endif %}
    </div>
      <a class="btn secondary" href="/experiments">Experiments</a>
      <a class="btn secondary" href="/datasets">Datasets</a>
      <a class="btn secondary" href="/scenarios">Scenarios</a>
      <a class="btn secondary" href="/warnings">Warnings</a>
      {% if role == 'admin' %}
      <a class="btn secondary" href="/admin/users">Admin Panel</a>
      {% endif %}
      <form method="post" action="/auth/logout" style="display:inline-block;">
        {{ csrf_input(request) | safe }}
        <button class="btn" type="submit">Logout</button>
      </form>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h3>Failures (latest)</h3>
      <table>
        <thead><tr><th>ID</th><th>Type</th><th>Severity</th><th>Apps</th><th>Occurrences</th></tr></thead>
        <tbody>
          {% for f in failures %}
          <tr>
            <td><span class="pill">{{ f.failure_id }}v{{ f.version }}</span></td>
            <td>{{ f.failure_type }}</td>
            <td>{{ f.impact_severity }}</td>
            <td>{{ (f.affected_apps or []) | join(",") }}</td>
            <td>{{ f.occurrences }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small">Source: GFKB (/failures)</p>
    </div>

    <div class="card">
      <h3>Patterns</h3>
      <table>
        <thead><tr><th>ID</th><th>Name</th><th>Affected apps</th></tr></thead>
        <tbody>
          {% for p in patterns %}
          <tr>
            <td><span class="pill">{{ p.pattern_id }}</span></td>
            <td>{{ p.name }}</td>
            <td>{{ (p.affected_apps or []) | join(",") }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small">Source: GFKB (/patterns)</p>
    </div>

    <div class="card full">
      <h3>Health score (app-A)</h3>
      <canvas id="healthChart" height="90"></canvas>
      <p class="small">Source: Health Scoring (/health/app-A)</p>
    </div>

    <div class="card full">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Warnings (recent)</h3>
        <a href="/warnings" class="small">View all</a>
      </div>
      <table style="margin-top:10px">
        <thead><tr><th>When</th><th>App</th><th>Action</th><th>Confidence</th><th>Pattern</th><th>Message</th></tr></thead>
        <tbody>
          {% for w in warnings %}
          <tr>
            <td class="small">{{ w.ts }}</td>
            <td><span class="pill">{{ w.app_id }}</span></td>
            <td>{{ w.action }}</td>
            <td>{{ w.confidence }}</td>
            <td>{{ w.pattern_id or '-' }}</td>
            <td class="small">{{ w.message }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small">Source: dashboard history</p>
    </div>
  </div>

  <script>
    const points = {{ health_points | tojson }};
    const labels = points.map(p => p.ts);
    const scores = points.map(p => p.score);

    const ctx = document.getElementById('healthChart');
    if (!window.Chart) {
      // Air-gapped-friendly fallback: no chart library available.
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'Chart.js not available (air-gapped mode). Health points still shown via API.';
      ctx?.parentElement?.appendChild(p);
    } else {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Health score',
          data: scores,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.2)',
          tension: 0.2,
        }]
      },
      options: {
        plugins: { legend: { labels: { color: '#e6edf3' } } },
        scales: {
          x: { ticks: { color: '#9aa8bf' } },
          y: { ticks: { color: '#9aa8bf' } }
        }
      }
    });
    }
  </script>
</body>
</html>
